<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Prusa MK3S+</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background-color: white;
        }
        .status-card {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background-color: white;
            border-radius: 10px;
        }
        .progress {
            height: 25px;
            margin: 10px 0;
        }
        .temp-display {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }
        .hidden {
            display: none;
        }
        #loading-spinner {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="login-screen">
        <div class="login-container text-center">
            <h2 class="mb-4">Monitoramento Prusa MK3S+</h2>
            <div id="login-error" class="alert alert-danger hidden" role="alert"></div>
            
            <form id="login-form">
                <div class="mb-3">
                    <input type="text" id="username" class="form-control" placeholder="Usuário" required>
                </div>
                <div class="mb-3">
                    <input type="password" id="password" class="form-control" placeholder="Senha" required>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="remember-me">
                    <label class="form-check-label" for="remember-me">Lembrar de mim</label>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <span id="login-btn-text">Entrar</span>
                    <div id="loading-spinner" class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </button>
            </form>
        </div>
    </div>

    <!-- Tela de Status -->
    <div id="status-screen" class="hidden">
        <div class="container">
            <div class="status-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Status da Impressora</h2>
                    <div>
                        <button id="refresh-btn" class="btn btn-sm btn-outline-primary">
                            <span id="refresh-text">Atualizar</span>
                            <span id="refresh-spinner" class="spinner-border spinner-border-sm hidden" role="status"></span>
                        </button>
                        <button id="logout-btn" class="btn btn-sm btn-outline-danger">Sair</button>
                    </div>
                </div>
                
                <div id="last-update" class="text-muted mb-3"></div>
                
                <div id="status-message" class="hidden">
                    <div class="alert" id="status-text"></div>
                </div>
                
                <div id="printer-data" class="hidden">
                    <div id="progress-container">
                        <div class="progress">
                            <div id="progress-bar" class="progress-bar" role="progressbar"></div>
                        </div>
                        <div class="text-center" id="progress-text"></div>
                    </div>
                    
                    <div class="temp-display">
                        <div class="card text-center" style="width: 48%">
                            <div class="card-header">Base</div>
                            <div class="card-body">
                                <h3 id="bed-temp">--</h3>
                                <span>°C</span>
                            </div>
                        </div>
                        
                        <div class="card text-center" style="width: 48%">
                            <div class="card-header">Bico</div>
                            <div class="card-body">
                                <h3 id="nozzle-temp">--</h3>
                                <span>°C</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Tempo Decorrido</div>
                                <div class="card-body">
                                    <h4 id="print-time">--</h4>
                                    <span>minutos</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Tempo Restante</div>
                                <div class="card-body">
                                    <h4 id="time-left">--</h4>
                                    <span>minutos</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="no-data-message" class="alert alert-warning hidden">
                    Nenhum dado disponível da impressora. Verifique se a impressora está enviando dados.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Elementos da interface
        const loginScreen = document.getElementById('login-screen');
        const statusScreen = document.getElementById('status-screen');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const loginError = document.getElementById('login-error');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loginBtnText = document.getElementById('login-btn-text');
        const refreshSpinner = document.getElementById('refresh-spinner');
        const refreshText = document.getElementById('refresh-text');
        const printerData = document.getElementById('printer-data');
        const noDataMessage = document.getElementById('no-data-message');
        const statusMessage = document.getElementById('status-message');

        // Configurações
        const API_URL = 'https://ertickmthh.pythonanywhere.com/status';
        const REMEMBER_ME_KEY = 'prusa_remember_me';
        const CREDS_KEY = 'prusa_auth_creds';

        // Gerenciamento de credenciais
        function storeCredentials(username, password, remember) {
            if (remember) {
                const creds = { username, password };
                localStorage.setItem(CREDS_KEY, JSON.stringify(creds));
                localStorage.setItem(REMEMBER_ME_KEY, 'true');
            } else {
                localStorage.removeItem(CREDS_KEY);
                localStorage.removeItem(REMEMBER_ME_KEY);
            }
        }

        function clearCredentials() {
            localStorage.removeItem(CREDS_KEY);
            localStorage.removeItem(REMEMBER_ME_KEY);
        }

        function getStoredCredentials() {
            const remember = localStorage.getItem(REMEMBER_ME_KEY) === 'true';
            const credsJson = localStorage.getItem(CREDS_KEY);
            
            if (remember && credsJson) {
                try {
                    return JSON.parse(credsJson);
                } catch {
                    return null;
                }
            }
            return null;
        }

        // Verifica login ao carregar a página
        function checkRememberMe() {
            const remember = localStorage.getItem(REMEMBER_ME_KEY) === 'true';
            if (remember) {
                document.getElementById('remember-me').checked = true;
                const creds = getStoredCredentials();
                if (creds) {
                    document.getElementById('username').value = creds.username || '';
                    // Não preenchemos a senha por segurança
                }
            }
        }

        // Mostra/oculta elementos
        function showLoading(show) {
            if (show) {
                loadingSpinner.style.display = 'inline-block';
                loginBtnText.style.display = 'none';
            } else {
                loadingSpinner.style.display = 'none';
                loginBtnText.style.display = 'inline-block';
            }
        }

        function showRefreshLoading(show) {
            if (show) {
                refreshSpinner.classList.remove('hidden');
                refreshText.classList.add('hidden');
            } else {
                refreshSpinner.classList.add('hidden');
                refreshText.classList.remove('hidden');
            }
        }

        // Login
        async function handleLogin(username, password, remember) {
            showLoading(true);
            loginError.classList.add('hidden');

            try {
                const authHeader = 'Basic ' + btoa(username + ':' + password);
                const response = await fetch(API_URL, {
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) {
                    throw new Error(response.status === 401 ? 
                        'Usuário ou senha incorretos' : 
                        `Erro na requisição: ${response.status}`);
                }

                // Login bem-sucedido
                storeCredentials(username, password, remember);
                loginScreen.classList.add('hidden');
                statusScreen.classList.remove('hidden');
                await fetchStatus();
                startAutoRefresh();
            } catch (error) {
                console.error('Erro no login:', error);
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            } finally {
                showLoading(false);
            }
        }

        // Logout
        function handleLogout() {
            clearCredentials();
            statusScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            stopAutoRefresh();
        }

        // Atualizar status
        async function fetchStatus() {
            showRefreshLoading(true);
            const creds = getStoredCredentials() || {};
            
            try {
                const authHeader = 'Basic ' + btoa(creds.username + ':' + creds.password);
                const response = await fetch(API_URL, {
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        handleLogout();
                        throw new Error('Sessão expirada. Por favor, faça login novamente.');
                    }
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Erro ao buscar status:', error);
                showErrorStatus(error.message);
            } finally {
                showRefreshLoading(false);
            }
        }

        // Atualiza a interface com os dados recebidos
        function updateUI(data) {
            document.getElementById('last-update').textContent = 
                `Última atualização: ${new Date().toLocaleString()}`;

            if (data.message && data.message === "Nenhum dado disponível") {
                printerData.classList.add('hidden');
                statusMessage.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }

            if (!data.status) {
                showErrorStatus('Dados inválidos recebidos');
                return;
            }

            // Mostra os dados
            noDataMessage.classList.add('hidden');
            printerData.classList.remove('hidden');
            statusMessage.classList.remove('hidden');

            // Status
            document.getElementById('status-text').textContent = data.status;
            const statusAlert = document.getElementById('status-text');
            statusAlert.className = 'alert ';
            
            if (data.status.toLowerCase().includes('error')) {
                statusAlert.classList.add('alert-danger');
            } else if (data.status.toLowerCase().includes('printing')) {
                statusAlert.classList.add('alert-primary');
            } else {
                statusAlert.classList.add('alert-success');
            }

            // Progresso
            const progress = parseFloat(data.progress || 0);
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress.toFixed(1)}%`;
            document.getElementById('progress-text').textContent = `${progress.toFixed(1)}% concluído`;

            // Temperaturas
            document.getElementById('bed-temp').textContent = data.bed_temp || '--';
            document.getElementById('nozzle-temp').textContent = data.nozzle_temp || '--';

            // Tempos
            document.getElementById('print-time').textContent = data.print_time || '--';
            document.getElementById('time-left').textContent = data.time_left || '--';
        }

        function showErrorStatus(message) {
            printerData.classList.add('hidden');
            noDataMessage.classList.add('hidden');
            statusMessage.classList.remove('hidden');
            
            const statusText = document.getElementById('status-text');
            statusText.textContent = message;
            statusText.className = 'alert alert-danger';
        }

        // Auto-refresh
        let refreshInterval;
        function startAutoRefresh() {
            stopAutoRefresh();
            refreshInterval = setInterval(fetchStatus, 30000); // 30 segundos
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            checkRememberMe();
            
            // Verifica se já está logado
            const creds = getStoredCredentials();
            if (creds) {
                loginScreen.classList.add('hidden');
                statusScreen.classList.remove('hidden');
                fetchStatus();
                startAutoRefresh();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const remember = document.getElementById('remember-me').checked;
            
            if (!username || !password) {
                loginError.textContent = 'Por favor, preencha usuário e senha';
                loginError.classList.remove('hidden');
                return;
            }
            
            await handleLogin(username, password, remember);
        });

        logoutBtn.addEventListener('click', handleLogout);
        refreshBtn.addEventListener('click', fetchStatus);
    </script>
</body>
</html>
